import matplotlib.pyplot as plt
import numpy as np
from scipy.spatial import procrustes
from sklearn.decomposition import PCA

x2 = np.array([[(121.0, 302.0), (129.0, 304.0), (136.5, 307.5), (142.5, 313.5), (145.5, 321.5), (149.5, 328.0),
                (155.5, 335.0), (158.0, 343.0), (159.5, 352.0), (162.5, 361.5), (163.5, 370.5), (169.6, 369.2),
                (176.4, 368.8), (184.8, 366.4), (192.4, 365.2), (199.6, 364.4), (206.8, 363.6), (214.4, 363.2),
                (222.4, 363.6), (230.4, 365.6), (238.0, 367.2), (245.6, 369.6), (250.8, 373.6), (256.8, 377.2),
                (262.4, 380.8), (268.4, 384.8), (274.0, 388.8), (278.8, 393.6), (282.0, 398.0), (286.0, 403.2),
                (289.6, 408.4), (292.4, 414.4), (295.6, 420.0), (296.4, 425.6), (296.8, 431.6), (296.8, 438.0),
                (296.4, 443.6), (299.2, 449.6), (303.6, 455.6), (308.8, 461.2), (308.8, 467.2), (263.2, 480.4),
                (262.5, 491.5), (261.0, 505.0), (264.0, 519.0), (267.0, 530.5), (271.5, 542.0), (278.5, 550.0),
                (288.0, 556.0), (298.5, 563.5), (311.0, 572.5), (323.0, 578.5), (338.0, 580.5), (352.0, 584.5),
                (365.5, 587.5), (378.0, 584.0), (386.5, 572.0), (398.0, 561.0), (405.0, 550.5), (415.0, 541.0),
                (429.0, 536.5), (445.0, 530.0), (447.0, 514.5), (448.5, 498.0), (449.5, 481.5), (447.0, 467.5),
                (436.5, 468.5), (425.0, 468.0), (415.0, 467.5), (403.5, 466.0), (393.5, 463.5), (383.5, 459.0),
                (374.5, 454.0), (365.5, 448.5), (358.0, 441.0), (352.0, 434.0), (346.0, 426.0), (340.0, 420.5),
                (335.5, 412.5), (329.0, 405.5), (324.5, 397.5), (318.5, 389.5), (313.5, 381.5), (308.0, 374.5),
                (303.5, 366.5), (298.5, 358.0), (294.5, 350.5), (289.0, 342.0), (286.5, 333.0), (284.0, 324.5),
                (282.0, 315.5), (282.0, 305.0), (285.5, 295.5), (293.0, 286.0), (295.0, 280.0)],
               [(109.5, 189.0), (115.0, 195.5), (118.0, 203.5), (123.0, 210.5), (125.5, 217.0), (127.5, 224.5),
                (129.5, 232.0), (132.0, 239.5), (135.0, 246.0), (133.0, 254.5), (128.66666666666666, 262.0),
                (134.0, 267.0), (140.5, 265.0), (145.5, 263.5), (150.5, 262.0), (156.0, 261.2), (162.4, 258.8),
                (168.0, 257.5), (174.0, 258.4), (179.5, 260.5), (184.0, 262.4), (189.5, 265.5), (194.0, 268.4),
                (198.8, 272.8), (203.6, 274.0), (208.8, 275.2), (212.4, 279.6), (215.6, 284.8), (217.6, 289.6),
                (219.2, 294.8), (222.5, 298.0), (224.0, 302.5), (225.5, 308.0), (225.0, 314.5), (227.5, 319.0),
                (229.0, 325.0), (231.5, 330.5), (232.5, 335.0), (233.0, 339.5), (234.0, 343.5), (231.0, 347.5),
                (192.5, 355.5), (191.5, 364.5), (193.0, 372.5), (195.5, 381.5), (198.5, 390.5), (202.0, 399.0),
                (206.5, 408.0), (213.0, 417.0), (222.5, 419.5), (234.5, 422.5), (244.0, 426.5), (254.5, 427.5),
                (265.0, 427.5), (276.5, 422.0), (285.0, 415.0), (293.5, 407.0), (301.5, 399.5), (309.0, 392.0),
                (314.0, 382.5), (320.5, 373.5), (328.5, 362.5), (329.0, 347.5), (330.5, 333.0), (330.0, 319.5),
                (330.0, 304.0), (325.5, 300.0), (318.0, 299.5), (311.5, 300.0), (304.5, 301.5), (298.5, 300.0),
                (292.5, 298.5), (286.5, 296.5), (280.5, 292.5), (274.5, 288.0), (268.0, 284.5), (261.5, 281.5),
                (254.5, 277.5), (250.0, 272.5), (245.5, 268.5), (241.5, 264.5), (237.5, 261.0), (234.5, 256.5),
                (230.5, 252.0), (227.5, 248.5), (223.5, 244.5), (220.5, 240.5), (216.5, 236.5), (212.0, 231.5),
                (208.5, 227.0), (204.5, 222.0), (207.5, 216.0), (210.5, 211.5), (215.0, 205.5), (220.0, 200.0)],
               [(108.5, 219.5), (114.0, 224.0), (119.5, 230.0), (122.0, 237.0), (125.0, 244.0),
                (128.66666666666666, 252.0), (129.33333333333334, 260.6666666666667), (132.0, 268.6666666666667),
                (135.33333333333334, 276.6666666666667), (139.5, 283.5), (140.0, 291.3333333333333), (146.0, 292.0),
                (150.0, 291.5), (154.5, 289.5), (158.5, 288.0), (163.5, 286.5), (168.5, 286.5), (173.0, 287.0),
                (178.5, 287.5), (182.5, 288.0), (187.0, 290.0), (193.0, 292.5), (199.5, 294.5), (204.5, 297.5),
                (210.0, 299.0), (214.5, 302.5), (219.5, 305.5), (224.5, 308.5), (228.5, 312.5), (232.5, 316.5),
                (235.5, 320.5), (238.5, 325.5), (239.0, 331.5), (241.5, 336.5), (244.5, 341.0), (245.0, 347.0),
                (245.5, 353.0), (244.0, 359.5), (243.0, 366.0), (243.0, 374.0), (246.5, 380.5), (207.0, 397.0),
                (204.0, 407.0), (206.0, 418.0), (209.0, 431.5), (211.5, 442.5), (217.0, 454.0), (223.0, 463.5),
                (230.5, 469.5), (239.5, 474.5), (248.5, 478.0), (259.5, 485.5), (270.5, 490.0), (284.0, 493.0),
                (297.5, 488.0), (309.0, 484.0), (319.5, 478.0), (326.5, 468.0), (332.5, 459.5), (342.5, 452.5),
                (350.5, 446.5), (359.5, 437.5), (360.0, 424.0), (362.0, 410.5), (363.5, 397.0), (360.0, 381.5),
                (352.5, 380.0), (343.5, 380.0), (334.0, 379.5), (326.5, 377.0), (318.5, 375.0), (309.5, 371.0),
                (302.0, 366.5), (296.5, 361.0), (291.5, 355.0), (285.0, 347.0), (280.0, 340.5), (275.5, 334.5),
                (271.5, 328.0), (268.5, 321.5), (265.0, 315.5), (261.5, 309.5), (258.0, 302.0), (254.5, 295.0),
                (250.0, 289.0), (246.0, 282.5), (242.0, 276.5), (239.5, 271.0), (237.5, 265.5), (235.5, 259.0),
                (234.0, 252.0), (234.0, 244.5), (237.0, 238.5), (240.0, 233.5), (245.0, 230.0)],
               [(173.0, 276.0), (176.5, 280.0), (180.0, 283.5), (185.5, 285.5), (189.0, 289.5), (192.5, 295.0),
                (195.0, 302.5), (195.5, 308.0), (193.5, 315.0), (190.5, 321.0), (186.5, 328.5), (191.5, 332.5),
                (196.5, 330.5), (201.5, 329.5), (206.5, 328.5), (211.5, 327.5), (216.0, 327.0), (221.0, 326.5),
                (226.0, 326.5), (231.0, 328.5), (235.5, 331.5), (239.5, 333.0), (243.5, 335.5), (247.5, 337.0),
                (251.5, 339.5), (255.5, 341.5), (259.5, 343.0), (263.5, 345.0), (268.0, 347.0), (272.5, 349.0),
                (275.0, 352.0), (277.5, 356.5), (279.0, 361.5), (280.5, 366.5), (280.0, 371.0), (282.0, 377.0),
                (283.0, 382.5), (282.5, 388.0), (281.5, 395.5), (283.0, 401.0), (283.5, 408.0), (244.0, 428.0),
                (243.0, 439.5), (244.5, 450.5), (247.0, 459.0), (252.5, 468.0), (259.5, 478.0), (266.5, 486.5),
                (277.5, 494.0), (287.0, 498.0), (297.5, 503.5), (309.0, 506.0), (322.5, 508.5), (334.0, 508.5),
                (347.5, 506.5), (357.5, 504.5), (366.5, 498.5), (370.0, 488.0), (376.0, 477.0), (385.0, 470.5),
                (397.5, 467.5), (407.5, 459.5), (407.5, 444.5), (407.0, 429.5), (406.0, 412.5), (406.0, 396.5),
                (397.0, 398.5), (388.5, 400.5), (379.0, 401.5), (370.5, 400.5), (361.0, 398.0), (353.5, 394.0),
                (346.5, 390.0), (338.0, 386.0), (332.5, 380.0), (326.0, 374.0), (321.5, 368.5), (317.0, 361.0),
                (312.0, 355.5), (307.5, 349.0), (303.5, 344.0), (299.0, 338.5), (294.5, 331.0), (290.0, 324.0),
                (285.5, 316.5), (279.0, 310.5), (276.5, 303.0), (275.0, 297.5), (274.5, 290.5), (274.0, 283.0),
                (275.0, 277.5), (277.5, 272.5), (281.0, 269.0), (287.0, 267.5), (291.0, 267.5)],
               [(111.6, 253.6), (118.0, 256.0), (124.0, 262.4), (131.2, 268.0), (136.4, 274.4), (139.2, 281.2),
                (142.8, 288.8), (143.2, 295.6), (146.0, 303.2), (151.6, 311.6), (149.6, 320.0), (157.5, 320.0),
                (163.5, 318.5), (168.0, 316.0), (174.0, 313.0), (179.5, 311.5), (186.0, 310.0), (192.0, 310.0),
                (198.5, 309.5), (202.5, 310.5), (207.0, 311.5), (212.5, 312.5), (218.0, 312.5), (224.0, 312.0),
                (230.5, 313.0), (236.5, 315.5), (240.5, 319.5), (244.0, 323.5), (249.0, 326.0), (253.5, 329.0),
                (257.0, 334.0), (260.0, 338.5), (262.5, 344.5), (264.5, 349.0), (264.5, 354.0), (265.5, 358.5),
                (265.5, 363.0), (266.0, 368.5), (266.5, 373.0), (268.0, 378.5), (267.0, 384.5), (240.8, 410.8),
                (241.2, 420.4), (244.66666666666666, 430.0), (246.4, 439.6), (252.0, 448.0), (257.5, 457.0),
                (263.5, 465.5), (272.5, 472.5), (281.5, 476.5), (290.5, 480.5), (301.0, 483.5), (311.5, 486.0),
                (322.5, 486.0), (332.5, 485.0), (343.0, 483.5), (353.0, 478.5), (359.5, 468.0), (365.0, 458.5),
                (371.0, 449.5), (380.0, 442.5), (386.0, 431.5), (386.0, 416.0), (385.0, 402.5), (384.5, 388.5),
                (379.0, 374.5), (371.5, 372.5), (364.0, 372.5), (357.5, 372.0), (350.5, 373.0), (340.8, 372.4),
                (332.8, 370.4), (325.2, 367.6), (317.2, 364.8), (309.6, 359.2), (302.4, 354.8), (296.8, 348.8),
                (289.6, 342.8), (283.2, 336.8), (277.2, 330.8), (273.2, 324.0), (268.8, 317.6), (264.8, 310.8),
                (260.0, 304.8), (257.6, 296.8), (254.0, 289.2), (251.6, 282.4), (248.8, 276.8), (247.6, 270.4),
                (246.4, 264.8), (247.2, 257.2), (249.2, 252.8), (252.0, 246.4), (256.4, 241.2), (262.8, 236.4)]])
shapes = x2
aligned_shapes = []

# calcula el promedio o la forma promedio
x_mean = np.mean(x2, axis=0)
# print(x_mean)
reference_shape = x2[0]

for shape in shapes:
    mtx1, mtx2, disparity = procrustes(reference_shape, shape)
    aligned_shapes.append(mtx2)
    sx, sy = mtx2.T
    # plt.plot(sx, -sy, 'r-', lw=1)

    # print('Disparity:',disparity)

mean_shape = np.mean(aligned_shapes, axis=0)

for shape in aligned_shapes:
    mtx1, mtx2, disparity = procrustes(mean_shape, shape)
    sx, sy = mtx2.T
    # plt.plot(sx, -sy, 'g-', lw=1)
    # print('Disparity 2:',disparity)

meanx, meany = mean_shape.T

plt.plot(meanx, -meany, 'r-', label='Mean Shape', lw=3)
plt.legend()

##############PCA############


# As√≠ deberia de estar los datos antes de PCA
data = np.reshape(aligned_shapes, (5, 190))

# data = data.T # 138x5

pca = PCA()
lowerdata = pca.fit_transform(data)

# c1 = np.reshape(pca.components_[0], (69,2))
c1 = pca.mean_ + pca.components_[0] * (-2 * np.sqrt(pca.explained_variance_[0]))
print(c1.shape)

c1 = np.reshape(c1, (95, 2))

# c1 = np.reshape(pca.mean_, (69,2))
c1_x, c1_y = c1.T

plt.plot(c1_x, -c1_y, 'k')

print('eigve', pca.components_.shape)
plt.show()

fig, ax = plt.subplots(1, 2)
ax[0].bar(np.arange(5), height=pca.explained_variance_ratio_ * 100)
ax[0].set_ylabel('Variance explanation factor (percent)')
ax[0].set_xlabel('Eigenvalue')
ax[1].plot(pca.explained_variance_ratio_)
ax[1].set_ylabel('Variance explanation factor')
ax[1].set_xlabel('Eigenvalue')

"""
def myplot(score,coeff,labels=None):
    xs = score[:,0]
    ys = score[:,1]
    n = coeff.shape[0]
    scalex = 1.0/(xs.max() - xs.min())
    scaley = 1.0/(ys.max() - ys.min())
    plt.scatter(xs * scalex,ys * scaley)
    for i in range(n):
        plt.arrow(0, 0, coeff[i,0], coeff[i,1],color = 'r',alpha = 0.5)
        if labels is None:
            plt.text(coeff[i,0]* 1.15, coeff[i,1] * 1.15, "Var"+str(i+1), color = 'g', ha = 'center', va = 'center')
        else:
            plt.text(coeff[i,0]* 1.15, coeff[i,1] * 1.15, labels[i], color = 'g', ha = 'center', va = 'center')
plt.xlim(-1,1)
plt.ylim(-1,1)
plt.xlabel("PC{}".format(1))
plt.ylabel("PC{}".format(2))
plt.grid()

myplot(lowerdata[:,0:2], np.transpose(pca.components_[0:2,:]))
"""
print('Variation', sum(pca.explained_variance_ratio_))
print(pca.explained_variance_ratio_)
plt.show()

# Forma promedio y sus variaciones
fig, arr = plt.subplots(3, 3)
pca_mean = np.reshape(pca.mean_, (95, 2))
pca_m_x, pca_m_y = pca_mean.T
for i in range(3):
    component_i_a = pca.mean_ + pca.components_[i] * (-2 * np.sqrt(pca.explained_variance_[i]))
    component_i_b = pca.mean_ + pca.components_[i] * (2 * np.sqrt(pca.explained_variance_[i]))

    c_i_a = np.reshape(component_i_a, (95, 2))
    c_i_b = np.reshape(component_i_b, (95, 2))
    c_ia_x, c_ia_y = c_i_a.T
    c_ib_x, c_ib_y = c_i_b.T

    arr[i][0].plot(c_ia_x, -c_ia_y, 'b')
    arr[i][0].set_title(r'$b_%2d = -3\sqrt{\lambda_%2d}$' % (i + 1, i + 1))
    arr[i][1].plot(pca_m_x, -pca_m_y, 'r')
    arr[i][1].set_title(r'$b_%2d = 0$' % (i + 1))
    arr[i][2].plot(c_ib_x, -c_ib_y, 'b')
    arr[i][2].set_title(r'$b_%2d = +3\sqrt{\lambda_%2d}$' % (i + 1, i + 1))
plt.show()
