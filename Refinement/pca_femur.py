import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.spatial import procrustes
from sklearn.decomposition import PCA


x2 = np.array([[(141.33333333333334, 610.6666666666666), (148.0, 604.0), (155.33333333333334, 598.6666666666666),
                (163.33333333333334, 592.0), (169.33333333333334, 584.0), (172.66666666666666, 575.3333333333334),
                (174.66666666666666, 566.6666666666666), (173.5, 556.5), (168.66666666666666, 548.0),
                (165.33333333333334, 540.0), (168.0, 533.0), (172.0, 527.5), (176.0, 521.5), (181.5, 515.5),
                (186.5, 509.5), (190.5, 504.0), (196.5, 499.5), (202.5, 495.0), (209.0, 492.0), (219.0, 493.5),
                (231.0, 495.0), (244.0, 495.5), (254.0, 489.0), (262.5, 480.0), (268.5, 471.5), (274.0, 462.5),
                (275.5, 451.0), (275.5, 438.0), (274.0, 418.5), (273.0, 406.5), (267.5, 396.5), (259.5, 387.5),
                (249.0, 381.0), (238.0, 376.5), (226.0, 373.5), (214.0, 372.5), (200.5, 374.5), (187.5, 378.5),
                (176.5, 384.0), (166.0, 392.5), (160.0, 402.5), (155.5, 414.0), (149.5, 422.5), (138.5, 425.0),
                (126.0, 425.0), (115.5, 424.5), (105.5, 420.0), (99.5, 414.0), (91.5, 405.5), (81.0, 400.0),
                (70.5, 399.5), (61.5, 410.0), (51.0, 420.5), (43.5, 431.0), (38.5, 443.5), (31.0, 456.0), (26.0, 468.0),
                (22.5, 483.0), (25.5, 496.5), (32.5, 507.0), (37.5, 517.5), (41.5, 528.5), (44.5, 540.5), (46.5, 552.0),
                (48.0, 563.0), (49.0, 574.5), (50.0, 585.0), (51.0, 598.0), (51.0, 609.0)],
               [(135.0, 431.0), (139.5, 425.5), (143.5, 421.0), (147.0, 416.0), (150.0, 411.5), (152.5, 405.5),
                (153.5, 400.0), (153.5, 393.5), (150.0, 388.5), (146.0, 383.0), (148.5, 378.5), (150.5, 374.5),
                (152.0, 370.0), (155.0, 366.0), (158.5, 362.5), (161.0, 358.0), (164.0, 354.5), (169.0, 352.0),
                (174.5, 351.0), (183.6, 352.4), (192.0, 351.6), (199.6, 346.0), (205.2, 339.6), (209.6, 331.2),
                (212.0, 322.4), (212.4, 312.0), (210.8, 302.8), (206.8, 293.6), (201.6, 287.6), (198.0, 280.0),
                (192.0, 275.6), (184.8, 271.2), (175.6, 268.8), (166.0, 268.0), (157.6, 268.4), (149.6, 269.6),
                (142.0, 273.2), (136.4, 277.6), (132.4, 282.4), (128.4, 287.6), (125.6, 293.6), (125.2, 300.8),
                (121.2, 306.0), (115.6, 311.2), (106.4, 311.2), (97.6, 309.6), (88.4, 306.0), (82.8, 299.6),
                (78.8, 292.0), (67.2, 290.4), (56.8, 290.8), (50.4, 296.4), (50.8, 305.6), (47.2, 315.6), (44.8, 324.8),
                (41.2, 334.8), (37.6, 344.0), (35.2, 354.8), (36.4, 364.8), (41.6, 369.6), (46.8, 375.6), (49.6, 381.2),
                (52.8, 387.6), (56.8, 394.0), (58.8, 401.2), (61.6, 408.4), (63.2, 416.4), (64.8, 423.6),
                (64.8, 430.0)],
               [(142.0, 532.0), (145.0, 525.5), (150.5, 520.0), (153.0, 514.0), (156.5, 507.5), (158.5, 500.5),
                (158.5, 493.5), (156.5, 487.5), (152.5, 481.5), (147.33333333333334, 476.0), (151.5, 466.5),
                (154.0, 455.5), (156.5, 445.5), (159.0, 435.0), (163.0, 425.0), (169.0, 415.5), (176.0, 405.5),
                (187.0, 397.5), (199.5, 392.0), (207.5, 389.5), (215.5, 386.5), (221.5, 380.0), (226.0, 374.0),
                (229.0, 366.0), (230.5, 358.0), (231.0, 350.5), (230.5, 342.5), (229.5, 333.5), (222.0, 321.0),
                (215.5, 312.0), (207.0, 306.0), (198.0, 301.0), (188.0, 298.0), (178.5, 297.0), (167.0, 298.0),
                (157.5, 300.5), (149.5, 304.5), (142.0, 309.0), (135.0, 316.0), (129.5, 323.0), (128.0, 332.5),
                (129.0, 342.5), (128.5, 352.5), (122.5, 360.5), (113.0, 367.5), (101.5, 370.5), (88.0, 372.0),
                (78.0, 365.5), (69.0, 359.5), (57.0, 356.0), (47.0, 359.5), (41.0, 369.0), (37.0, 382.5), (34.5, 394.5),
                (30.0, 405.5), (26.0, 416.0), (22.0, 427.5), (23.5, 439.0), (27.0, 451.0), (35.5, 459.5), (41.5, 465.0),
                (46.0, 472.5), (50.5, 480.0), (54.5, 489.5), (57.0, 498.5), (60.5, 506.5), (62.0, 515.5), (64.5, 523.5),
                (66.5, 532.5)],
               [(174.66666666666666, 521.3333333333334), (179.5, 517.5), (185.0, 513.5), (189.5, 508.5), (192.5, 503.5),
                (192.0, 498.0), (192.5, 492.5), (189.5, 488.5), (186.5, 483.5), (184.66666666666666, 477.3333333333333),
                (185.0, 470.5), (187.5, 464.0), (190.5, 458.5), (193.5, 452.5), (197.5, 446.5), (202.0, 441.0),
                (207.0, 436.0), (213.5, 431.0), (221.0, 428.0), (230.5, 428.5), (239.5, 427.5), (248.0, 425.5),
                (256.0, 421.0), (262.0, 415.5), (267.5, 408.5), (270.5, 400.0), (269.5, 391.5), (266.5, 383.0),
                (262.5, 366.0), (260.5, 355.5), (254.5, 348.5), (246.0, 342.5), (236.0, 337.5), (225.0, 336.0),
                (215.0, 336.5), (205.5, 337.0), (196.0, 341.0), (189.5, 345.0), (182.0, 351.0), (177.5, 358.0),
                (173.5, 366.5), (171.5, 375.0), (168.0, 382.0), (162.5, 389.5), (154.0, 394.5), (144.5, 397.0),
                (133.0, 398.5), (122.5, 396.0), (116.0, 387.0), (109.0, 377.0), (99.5, 372.5), (92.0, 379.0),
                (85.5, 388.5), (81.5, 399.0), (76.5, 409.0), (74.0, 420.0), (71.0, 431.0), (68.0, 442.5), (71.5, 454.0),
                (78.0, 464.0), (82.0, 471.0), (85.5, 477.0), (88.5, 482.5), (90.5, 488.0), (93.5, 494.5), (95.0, 501.0),
                (96.5, 508.5), (97.0, 515.5), (98.5, 522.5)],
               [(158.66666666666666, 516.6666666666666), (163.0, 511.5), (170.5, 506.5), (176.5, 501.5), (179.0, 494.0),
                (180.5, 486.5), (179.5, 478.0), (176.5, 471.0), (172.5, 464.0), (167.0, 457.5), (170.5, 450.0),
                (173.5, 443.5), (177.5, 437.0), (181.0, 431.5), (185.5, 426.0), (189.5, 421.5), (194.5, 417.0),
                (201.0, 416.0), (209.0, 415.0), (219.0, 417.5), (227.5, 416.0), (235.0, 411.5), (240.5, 403.0),
                (246.0, 395.0), (249.0, 385.0), (252.0, 374.5), (252.0, 366.0), (249.0, 358.0), (247.5, 346.0),
                (243.0, 339.5), (237.0, 332.0), (229.0, 325.0), (219.5, 321.5), (208.5, 319.5), (197.5, 318.5),
                (186.5, 318.5), (176.0, 322.5), (166.5, 328.5), (158.5, 335.5), (152.0, 343.0), (147.0, 353.5),
                (147.5, 365.5), (141.5, 371.5), (135.0, 374.0), (127.0, 377.0), (119.0, 379.0), (110.0, 380.5),
                (101.0, 378.5), (92.5, 372.0), (87.5, 366.0), (78.0, 362.5), (73.0, 368.0), (67.5, 375.5),
                (63.5, 384.0), (59.5, 393.5), (55.0, 403.5), (51.5, 414.0), (51.5, 425.5), (51.0, 436.5), (59.5, 444.0),
                (64.0, 450.5), (70.0, 458.5), (73.5, 465.5), (77.0, 472.0), (80.0, 481.0), (82.5, 490.0), (84.0, 498.0),
                (86.0, 506.0), (87.5, 515.0)]])
shapes = x2
aligned_shapes = []

# calcula el promedio o la forma promedio
x_mean = np.mean(x2, axis=0)
# print(x_mean)
reference_shape = x2[0]

for shape in shapes:
    mtx1, mtx2, disparity = procrustes(reference_shape, shape)
    aligned_shapes.append(mtx2)
    sx, sy = mtx2.T
    # plt.plot(sx, -sy, 'r-', lw=1)

    # print('Disparity:',disparity)

mean_shape = np.mean(aligned_shapes, axis=0)

meanx, meany = mean_shape.T

# plt.plot(meanx, -meany, 'b-', label='Mean Shape 1', lw=3)


new_aligned_shapes = []

for shape in aligned_shapes:
    mtx1, mtx2, disparity = procrustes(mean_shape, shape)
    new_aligned_shapes.append(mtx2)
    sx, sy = mtx2.T
    # plt.plot(sx, -sy, 'g-', lw=1)
    # print('Disparity 2:',disparity)

mean_shape = np.mean(new_aligned_shapes, axis=0)

meanx, meany = mean_shape.T

plt.plot(meanx, -meany, 'r-', label='Mean Shape 2', lw=3)
plt.legend()

##############PCA############


# Así deberia de estar los datos antes de PCA
data = np.reshape(new_aligned_shapes, (5, 138))

# data = data.T # 138x5

pca = PCA()
pca_data = pca.fit_transform(data)

# c1 = np.reshape(pca.components_[0], (69,2))
c1 = pca.mean_ + pca.components_[0] * (-3 * np.sqrt(pca.explained_variance_[0]))
# c1 = pca.mean_ + pca.components_[2]*(-3*pca.explained_variance_[2])
print(c1.shape)

c1 = np.reshape(c1, (69, 2))

# c1 = np.reshape(pca.mean_, (69,2))
c1_x, c1_y = c1.T

plt.plot(c1_x, -c1_y, 'k')

print('eigve', pca.components_.shape)
plt.show()

fig, ax = plt.subplots(1, 2)
ax[0].bar(np.arange(5), height=pca.explained_variance_ratio_ * 100)
ax[0].set_ylabel('Variance explanation factor (percent)')
ax[0].set_xlabel('Eigenvalue')
ax[1].plot(pca.explained_variance_ratio_)
ax[1].set_ylabel('Variance explanation factor')
ax[1].set_xlabel('Eigenvalue')

print('Variation:', sum(pca.explained_variance_ratio_))
print(pca.explained_variance_ratio_)
plt.show()

# Forma promedio y sus variaciones
fig, arr = plt.subplots(3, 3)
pca_mean = np.reshape(pca.mean_, (69, 2))
pca_m_x, pca_m_y = pca_mean.T
for i in range(3):
    component_i_a = pca.mean_ + pca.components_[i] * (-3 * np.sqrt(pca.explained_variance_[i]))
    component_i_b = pca.mean_ + pca.components_[i] * (3 * np.sqrt(pca.explained_variance_[i]))

    c_i_a = np.reshape(component_i_a, (69, 2))
    c_i_b = np.reshape(component_i_b, (69, 2))
    c_ia_x, c_ia_y = c_i_a.T
    c_ib_x, c_ib_y = c_i_b.T

    arr[i][0].plot(c_ia_x, -c_ia_y, 'b')
    arr[i][0].set_title(r'$b_%2d = -3\sqrt{\lambda_%2d}$' % (i + 1, i + 1))
    arr[i][0].axis('off')
    arr[i][1].plot(pca_m_x, -pca_m_y, 'r')
    arr[i][1].set_title(r'$b_%2d = 0$' % (i + 1))
    arr[i][1].axis('off')
    arr[i][2].plot(c_ib_x, -c_ib_y, 'b')
    arr[i][2].set_title(r'$b_%2d = +3\sqrt{\lambda_%2d}$' % (i + 1, i + 1))
    arr[i][2].axis('off')
plt.show()

########
# Nuevos gráficos
name_shapes = ['Shape' + str(x) for x in range(1, len(shapes) + 1)]

per_var = np.round(pca.explained_variance_ratio_ * 100, decimals=1)
labels = ['PC' + str(x) for x in range(1, len(per_var) + 1)]
plt.bar(x=range(1, len(per_var) + 1), height=per_var, tick_label=labels)
plt.ylabel('Percentage of Explained Variance')
plt.xlabel('Principal Component')
plt.title('Variance Plot')
plt.show()

pca_df = pd.DataFrame(pca_data, index=name_shapes, columns=labels)
plt.scatter(pca_df.PC1, pca_df.PC2)
plt.title('My PCA Graph: PC1 vs PC2')
plt.xlabel('PC1 - {0}%'.format(per_var[0]))
plt.ylabel('PC2 - {0}%'.format(per_var[1]))

for name in name_shapes:
    plt.annotate(name, (pca_df.PC1.loc[name], pca_df.PC2.loc[name]))

plt.grid()
plt.show()
